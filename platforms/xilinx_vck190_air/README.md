# VCK190 AIR Platform
## Prerequisites

The VCK190 AIR platform is tested with the following tool versions:
- Ubuntu 20.04
- Vitis 2021.2
- Petalinux 2021.2

The host system should be configured to build [PYNQ](git@gitenterprise.xilinx.com:jefff/PYNQ.git) ([Documentation](https://pynq.readthedocs.io/en/latest/pynq_sd_card.html#prepare-the-building-environment)).

## Overview

The AIR platform for the vck190 board consists of an AIR compatible Vivado design and a PYNQ based file-system.

Building the SD card image for this platform involves a few manual steps:

1. Build the hardware design and petalinux base platform. This will generate .xsa and .bsp to be used as input to the PYNQ build flow.

2. Build the custom PYNQ filesystem. Build step requires a machine with root/sudo access in order for some mount/fs commands to run.

3. Copy BOOT.BIN generated in step (1) to the SD card boot partition. This enables the proper MicroBlaze reset boot sequence.

## Step 1 - Build petalinux-base platform

Configure the environment for Vitis (Vivado) 2020.1 and petalinux 2020.1:

    $ source /path/to/Vitis/2021.2/settings64.sh
    $ source /path/to/petalinux/2021.2/settings.sh

Build the XSA and BSP files:

    cd mlir-air/platforms/xilinx_vck190_air
    make pynq

This will generate the .xsa and .bsp files and copy them to `mlir-air/pynq/vck190_air`. It will also generate the `BOOT.bin` file used in step (3).

## Step 2 - Build PYNQ Filesystem

Clone the PYNQ repository and checkout the v2.7 branch:

    git clone https://github.com/Xilinx/PYNQ.git
    cd PYNQ
    git checkout -b image_v2.7_air origin/image_v2.7

Apply the AIR patch to the PYNQ repository

    cd PYNQ
    patch -p 1 < /path/to/mlir-air/pynq/vck190/pynq_v2.7_air.patch

We will build PYNQ using a
[pre-built board-agnostic image](https://pynq.readthedocs.io/en/latest/pynq_sd_card.html#using-the-prebuilt-board-agnostic-imageCopy).
Download the image from the 
[PYNQ boards page](http://www.pynq.io/board.html/)
and copy the file to `PYNQ/sdbuild/output`.

    wget https://bit.ly/pynq_aarch64_2_7
    mkdir -p PYNQ/sdbuild/output
    mv pynq_aarch64_2_7 PYNQ/sdbuild/output/focal.aarch64.2.7.0.tar.gz

Then build the PYNQ SD card image:

    cd PYNQ/sdbuild
    make PREBUILT=output/focal.aarch64.2.7.0.tar.gz BOARDDIR=</path/to/mlir-air/pynq> nocheck_images 

The image file wil be written to `PYNQ/sdbuild/output/vck190_air-2.7.0.img`. This file can be written to a SD card and used to boot a vck190 board.

This generates an sd image file (sd_card.img) with two partitions, a primary fat32 boot partition and an ext4 filesystem partition.

## Step 3 - Copy BOOT.BIN

The SD image generated in step (2) contains two partitions. The first partition is the boot partition which contains a BOOT.BIN file.
The BOOT.BIN file generated by PYNQ does not automatically bring the AIR MicroBlaze controllers out of reset.

To enable the MicroBlaze controllers during boot it is necessary to overwrite the PYNQ generated BOOT.BIN with the one generated in step (1). This file is `mlir-air/platforms/xilinx_vck190_air/bootgen/BOOT.BIN`.
 
Copy the BOOT.BIN from step (1) to the SD image by mounting the .img file, by using an SD card reader with a PC after writing the image, or by mounting the partition on a running board.

-----

<p align="center">Copyright&copy; 2019-2022 Advanced Micro Devices, Inc.</p>